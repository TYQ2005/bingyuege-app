<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>å†°é˜…</title>
  <style>
    :root {
      --primary: #2575fc;
      --bg-light: #f5f5f5;
      --card-light: #ffffff;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border: #e0e0e0;
    }
    .dark-mode {
      --primary: #4080ff;
      --bg-light: #121212;
      --card-light: #1e1e1e;
      --text-primary: #e0e0e0;
      --text-secondary: #9e9e9e;
      --border: #333333;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
    body { 
      background: var(--bg-light); 
      color: var(--text-primary); 
      padding-bottom: 60px;
      transition: background 0.3s, color 0.3s;
    }
    
    /* æ ¸å¿ƒå¸ƒå±€ (ä¿æŒä¸å˜) */
    .top-bar {
      position: fixed; top: 0; left: 0; width: 100%;
      height: 50px; background: var(--primary); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: bold;
      z-index: 10;
    }
    .page {
      margin-top: 60px; padding: 15px; display: none;
      min-height: calc(100vh - 110px);
    }
    .page.active { display: block; }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%;
      height: 50px; background: var(--card-light); border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 10;
      transition: background 0.3s, border-color 0.3s;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      font-size: 12px; color: var(--text-secondary);
      cursor: pointer;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 20px; margin-bottom: 3px; }

    /* é€šç”¨ç»„ä»¶ (ä¿æŒä¸å˜) */
    .card { 
      background: var(--card-light); 
      border-radius: 8px; 
      padding: 15px; 
      margin-bottom: 10px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s;
    }
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px;
      background: var(--primary); color: #fff; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-danger { background: #dc3545; color: #fff; }
    .add-btn {
      position: fixed; bottom: 70px; right: 20px;
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary); color: #fff; border: none;
      font-size: 20px; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
      z-index: 99;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card-light); 
      padding: 20px; border-radius: 8px;
      width: 90%; max-width: 400px;
      border: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-primary); }
    .form-control {
      width: 100%; padding: 10px; border: 1px solid var(--border);
      border-radius: 4px; font-size: 16px;
      background: var(--card-light);
      color: var(--text-primary);
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    .form-control::placeholder { color: var(--text-secondary); }
    .source-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .source-item:hover { background: rgba(0,0,0,0.02); }
    .toast {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 8px 16px; border-radius: 20px;
      display: none;
      z-index: 999;
    }
    .toast.show { display: block; }

    /* åŠ è½½ä¸­ (æ–°å¢ï¼Œå¤ç”¨åŸæœ‰é€»è¾‘) */
    .loading {
      text-align: center; padding: 40px 0; color: var(--text-secondary);
    }
    .loading::after {
      content: ''; display: block; width: 30px; height: 30px; margin: 20px auto;
      border: 3px solid var(--border); border-top-color: var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ä¹¦ç±ä¸ä¹¦æ¶æ ·å¼ (æ–°å¢ï¼Œä¿æŒé£æ ¼ç»Ÿä¸€) */
    .book-item {
      display: flex; gap: 10px; padding: 10px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .book-cover {
      width: 60px; height: 80px; background: #eee; border-radius: 4px;
      overflow: hidden;
    }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { flex: 1; }
    .book-title { font-weight: bold; margin-bottom: 4px; }
    .book-author, .book-progress { font-size: 12px; color: var(--text-secondary); }

    /* é˜…è¯»å™¨ (æ–°å¢ï¼Œä¿æŒäº¤äº’ä¹ æƒ¯) */
    .reader-page { padding: 20px; line-height: 1.8; font-size: 16px; }
    .reader-content { margin-bottom: 60px; }
    .reader-toolbar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.7); color: #fff;
      display: flex; justify-content: space-around; padding: 10px 0; z-index: 90;
    }
    .reader-tool {
      display: flex; flex-direction: column; align-items: center; font-size: 12px; cursor: pointer;
    }

    /* ç›®å½•é¡µ (æ–°å¢) */
    .catalog-page { padding: 0; }
    .catalog-header {
      padding: 15px; background: var(--primary); color: #fff;
      display: flex; justify-content: space-between; align-items: center;
    }
    .catalog-list {
      padding: 15px; height: calc(100vh - 110px); overflow-y: auto;
    }
    .catalog-item {
      padding: 8px 0; border-bottom: 1px solid var(--border); cursor: pointer;
    }
    .catalog-item.current { color: var(--primary); font-weight: bold; }

    /* æ›´å¤šåŠŸèƒ½æ ·å¼ (ä¿æŒä¸å˜) */
    .setting-item {
      display: flex; justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-desc {
      font-size: 12px; color: var(--text-secondary);
    }
    .toggle {
      position: relative;
      width: 44px; height: 22px;
      background: var(--border);
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.active { background: var(--primary); }
    .toggle::after {
      content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%;
      background: #fff; top: 2px; left: 2px; transition: left 0.3s;
    }
    .toggle.active::after { left: 24px; }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª (ä¿æŒä¸å˜) -->
  <div class="top-bar">å†°é˜… Â· ä¹¦æºç®¡ç†</div>

  <!-- 1. ä¹¦æºç®¡ç†é¡µ (ä¿æŒåŸæœ‰ç»“æ„) -->
  <div id="pageSource" class="page active">
    <div class="card">
      <h3 style="margin-bottom: 10px; font-size: 16px;">ä¹¦æºåˆ—è¡¨</h3>
      <div id="sourceList"></div>
    </div>
    <button class="add-btn" onclick="openModal()">+</button>
  </div>

  <!-- 2. ä¹¦æ¶é¡µ (åŠŸèƒ½å‡çº§ï¼šè”åŠ¨é˜…è¯»è¿›åº¦) -->
  <div id="pageShelf" class="page">
    <div class="card">
      <h3 style="font-size: 16px; margin-bottom: 15px;">æˆ‘çš„ä¹¦æ¶</h3>
      <div id="shelfList">
        <p style="color: var(--text-secondary);">æš‚æ— ä¹¦ç±ï¼Œå»ä¹¦æºä¸­æ·»åŠ å§</p>
      </div>
    </div>
  </div>

  <!-- 3. ä¹¦ç±åˆ—è¡¨é¡µ (ä¿æŒåŸæœ‰å…¥å£) -->
  <div id="pageBooks" class="page">
    <div class="card">
      <h3 style="font-size: 16px; margin-bottom: 15px;">
        <span id="sourceBookTitle">ä¹¦æºä¹¦ç±</span>
        <button class="btn btn-secondary" style="float: right; font-size: 12px;" onclick="switchPage('pageSource')">è¿”å›</button>
      </h3>
      <div id="bookList"></div>
    </div>
  </div>

  <!-- 4. é˜…è¯»å™¨é¡µ (æ–°å¢ï¼šåŠ å…¥ä¹¦æ¶é€»è¾‘) -->
  <div id="pageReader" class="page reader-page">
    <div id="readerContent" class="reader-content"></div>
    <div class="reader-toolbar">
      <div class="reader-tool" onclick="prevChapter()">
        <i>â¬…ï¸</i>
        <span>ä¸Šä¸€ç« </span>
      </div>
      <div class="reader-tool" onclick="addToShelf()">
        <i>ğŸ“š</i>
        <span>åŠ å…¥ä¹¦æ¶</span>
      </div>
      <div class="reader-tool" onclick="switchPage('pageCatalog')">
        <i>â˜°</i>
        <span>ç›®å½•</span>
      </div>
      <div class="reader-tool" onclick="nextChapter()">
        <i>â¡ï¸</i>
        <span>ä¸‹ä¸€ç« </span>
      </div>
    </div>
  </div>

  <!-- 5. ç›®å½•é¡µ (æ–°å¢) -->
  <div id="pageCatalog" class="page catalog-page">
    <div class="catalog-header">
      <span id="catalogBookTitle">ç›®å½•</span>
      <button class="btn btn-secondary" style="font-size: 12px;" onclick="switchPage('pageReader')">è¿”å›</button>
    </div>
    <div id="catalogList" class="catalog-list">
      <div class="loading">åŠ è½½ç›®å½•ä¸­...</div>
    </div>
  </div>

  <!-- 6. æ›´å¤šé¡µ (ä¿æŒä¸å˜) -->
  <div id="pageMore" class="page">
    <div class="card">
      <h3 style="font-size: 16px; margin-bottom: 15px;">ç³»ç»Ÿè®¾ç½®</h3>
      <div class="setting-item" onclick="toggleDarkMode()">
        <span>å¤œé—´æ¨¡å¼</span>
        <div class="toggle" id="darkModeToggle"></div>
      </div>
      <div class="setting-item" onclick="clearCache()">
        <span>æ¸…é™¤ç¼“å­˜</span>
        <span class="setting-desc">åˆ é™¤æ‰€æœ‰ä¹¦æºå’Œä¹¦æ¶æ•°æ®</span>
      </div>
    </div>
  </div>

  <! -- æ·»åŠ /ç¼–è¾‘ä¹¦æºå¼¹çª— (ä¿æŒåŸæœ‰ç»“æ„) -->
  <div èº«ä»½æ ‡è¯†="æ¨¡æ€" ç­çº§="æ¨¡æ€">
    <div ç­çº§="æ¨¡æ€å†…å®¹">
      <H3 èº«ä»½æ ‡è¯†="modalTitle" é£æ ¼="åº•è¾¹è·: 15PX; å­—ä½“å¤§å°: 18PX;">æ·»åŠ ä¹¦æº</H3>
      <è¾“å…¥ ç±»å‹="éšè—" èº«ä»½æ ‡è¯†="SourceID">
      <div ç­çº§="çª—ä½“ç»„">
        <æ ‡ç­¾>ä¹¦æºåç§°</æ ‡ç­¾>
        <è¾“å…¥ ç±»å‹="æ–‡æœ¬" èº«ä»½æ ‡è¯†="SourceName" ç­çº§="çª—ä½“æ§ä»¶" å ä½ç¬¦="ä¾‹å¦‚ï¼šç¬”è¶£é˜">
      </div>
      <div ç­çº§="çª—ä½“ç»„">
        <æ ‡ç­¾>ä¹¦æºåœ°å€</æ ‡ç­¾>
        <è¾“å…¥ ç±»å‹="æ–‡æœ¬" èº«ä»½æ ‡è¯†="sourceUrl" ç­çº§="çª—ä½“æ§ä»¶" å ä½ç¬¦="https://xxx.com">
      </div>
      <div é£æ ¼="æ˜¾ç¤º: å¼¯æ›²; å·®è·: 10PX; ä¸Šè¾¹è·: 20PX;">
        <æŒ‰é’® ç­çº§="btn btn-äºŒçº§" onClick="closeModal()">å–æ¶ˆ</æŒ‰é’®>
        <æŒ‰é’® ç­çº§="btn" onClick="saveSource()">ä¿å­˜</æŒ‰é’®>
      </div>
    </div>
  </div>

  <! -- æç¤ºæ¡† (ä¿æŒä¸å˜) -->
  <div èº«ä»½æ ‡è¯†="åå¸" ç­çº§="åå¸"></div>

  <! -- åº•éƒ¨å¯¼èˆª (ä¿æŒä¸å˜) -->
  <div ç­çº§="åº•éƒ¨å¯¼èˆª">
    <div ç­çº§="å¯¼èˆªé¡¹ç›®" onClick="switchPage('pageShelf')">
      <æˆ‘>ğŸ“š</æˆ‘>
      <è·¨åº¦>ä¹¦æ¶</è·¨åº¦>
    </div>
    <div ç­çº§="å¯¼èˆªé¡¹ç›®å·²æ¿€æ´»" onClick="switchPage('pageSource')">
      <æˆ‘>âš™ï¸</æˆ‘>
      <è·¨åº¦>ä¹¦æº</è·¨åº¦>
    </div>
    <div ç­çº§="å¯¼èˆªé¡¹ç›®" onClick="switchPage('pageMore')">
      <æˆ‘>â˜°</æˆ‘>
      <è·¨åº¦>æ›´å¤š</è·¨åº¦>
    </div>
  </div>

  <è„šæœ¬>
    //=====================åŸæœ‰å…¨å±€å˜é‡(ä¿æŒä¸å˜)=====================
    è®© æ¥æº=JSON.è§£æ(localStorage.getitem('æ¥æº')||'[]');
    è®© currentEditId=æ— æ•ˆçš„;
    è®© isDarkMode=localStorage.getitem('darkMode')==='true';
    è®© currentSource=æ— æ•ˆçš„;
    è®© currentBook=æ— æ•ˆçš„;
    è®© currentChapters=[];
    è®© currentChapterIndex=0;

    //=====================æ–°å¢å…¨å±€å˜é‡(è”åŠ¨æ ¸å¿ƒ)=====================
    è®© shelfBooks=JSON.è§£æ(localStorage.getitem('shelfBooks')||'[]'); // ä¹¦æ¶æ•°æ®

    //=====================åˆå§‹åŒ–(ä¿æŒåŸæœ‰é€»è¾‘+æ–°å¢æ¸²æŸ“)=====================
    çª—æˆ·.onload=åŠŸèƒ½() {
      renderSources();    // åŸæœ‰é€»è¾‘
      renderShelf();      // æ–°å¢é€»è¾‘
      initDarkMode();     // åŸæœ‰é€»è¾‘
    };

    //=====================é¡µé¢åˆ‡æ¢(ä¿æŒåŸæœ‰é€»è¾‘ï¼Œå…¼å®¹æ–°é¡µé¢)=====================
    åŠŸèƒ½ switchPage(pageId) {
      æ–‡ä»¶.querySelectorAll('.page').foreach(é¡µ=>é¡µ.classList.ç§»é™¤('æ´»åŠ¨'));
      æ–‡ä»¶.getElementById(pageId).classList.æ·»åŠ ('æ´»åŠ¨');
      
      æ–‡ä»¶.querySelectorAll('.nav-item').foreach(é¡¹=>{
        é¡¹.classList.ç§»é™¤('æ´»åŠ¨');
        å¦‚æœ (é¡¹.onClick.toString().åŒ…æ‹¬(pageId)) {
          é¡¹.classList.æ·»åŠ ('æ´»åŠ¨');
        }
      });
      
      // æ ‡é¢˜è”åŠ¨ (æ–°å¢é¡µé¢æ”¯æŒ)
      Const æ ‡é¢˜={
        'pageSource': 'å†°é˜… Â· ä¹¦æºç®¡ç†',
        'pageShelf': 'å†°é˜… Â· æˆ‘çš„ä¹¦æ¶',
        'pageBooks': 'å†°é˜… Â· ä¹¦ç±åˆ—è¡¨',
        'PageReader': 'å†°é˜… Â· é˜…è¯»å™¨',
        'pageCatalog': 'å†°é˜… Â· ç« èŠ‚åˆ—è¡¨',
        'pageMore': 'å†°é˜… Â· æ›´å¤šåŠŸèƒ½'
      };
      æ–‡ä»¶.querySelector('.é¡¶æ ').å†…éƒ¨æ–‡æœ¬=æ ‡é¢˜[pageId];
    }

    //=====================åŸæœ‰ä¹¦æºç®¡ç†é€»è¾‘(å®Œå…¨ä¿æŒä¸å˜)=====================
    åŠŸèƒ½ renderSources() {
      Const SourceList=æ–‡ä»¶.getElementById('SourceList');
      å¦‚æœ (æ¥æº.é•¿åº¦===0) {
        SourceList.innerHTML='<p style="color:var(--text-secondary)ï¼›">æš‚æ— ä¹¦æºï¼Œç‚¹å‡»å³ä¸‹è§’æ·»åŠ </p>';
        return;
      }
      sourceList.innerHTML = '';
      sources.forEach(source => {
        const item = document.createElement('div');
        item.className = 'source-item';
        item.onclick = () => loadBooksFromSource(source); // ç‚¹å‡»é€»è¾‘ä¸å˜
        item.innerHTML = `
          <div>
            <strong>${source.name}</strong>
            <p style="font-size: 12px; color: var(--text-secondary);">${source.url}</p>
          </div>
          <div style="display: flex; gap: 5px;">
            <button class="btn btn-secondary" onclick="event.stopPropagation(); editSource('${source.id}')">ç¼–è¾‘</button>
            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteSource('${source.id}')">åˆ é™¤</button>
          </div>
        `;
        sourceList.appendChild(item);
      });
    }

    function openModal() { /* ä¿æŒä¸å˜ */
      currentEditId = null;
      document.getElementById('modalTitle').innerText = 'æ·»åŠ ä¹¦æº';
      document.getElementById('sourceId').value = '';
      document.getElementById('sourceName').value = '';
      document.getElementById('sourceUrl').value = '';
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() { /* ä¿æŒä¸å˜ */
      document.getElementById('modal').classList.remove('show');
    }

    function saveSource() { /* ä¿æŒä¸å˜ */
      const id = document.getElementById('sourceId').value || Date.now().toString();
      const name = document.getElementById('sourceName').value.trim();
      const url = document.getElementById('sourceUrl').value.trim();

      if (!name || !url) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      if (currentEditId) {
        sources = sources.map(s => s.id === currentEditId ? { id, name, url } : s);
      } else {
        sources.push({ id, name, url });
      }

      localStorage.setItem('sources', JSON.stringify(sources));
      renderSources();
      closeModal();
      showToast('ä¿å­˜æˆåŠŸ');
    }

    function editSource(id) { /* ä¿æŒä¸å˜ */
      const source = sources.find(s => s.id === id);
      if (!source) return;
      currentEditId = id;
      document.getElementById('modalTitle').innerText = 'ç¼–è¾‘ä¹¦æº';
      document.getElementById('sourceId').value = source.id;
      document.getElementById('sourceName').value = source.name;
      document.getElementById('sourceUrl').value = source.url;
      document.getElementById('modal').classList.add('show');
    }

    function deleteSource(id) { /* ä¿æŒä¸å˜ */
      if (confirm('ç¡®å®šåˆ é™¤è¯¥ä¹¦æºå—ï¼Ÿ')) {
        sources = sources.filter(s => s.id !== id);
        localStorage.setItem('sources', JSON.stringify(sources));
        renderSources();
        showToast('åˆ é™¤æˆåŠŸ');
      }
    }

    // ===================== åŸæœ‰ä¹¦ç±åŠ è½½é€»è¾‘ (ä¼˜åŒ–ï¼šæ”¯æŒçœŸå®ç‚¹å‡») =====================
    function loadBooksFromSource(source) {
      currentSource = source;
      document.getElementById('sourceBookTitle').innerText = `${source.name} - ä¹¦ç±åˆ—è¡¨`;
      
      // æ¨¡æ‹Ÿæ•°æ®ç»“æ„ä¿æŒä¸å˜ï¼Œä¾¿äºåç»­æ‰©å±•
      const mockBooks = [
        { 
          id: 'b1', 
          title: 'æ–—ç ´è‹ç©¹', 
          author: 'å¤©èš•åœŸè±†', 
          cover: 'https://via.placeholder.com/60x80?text=æ–—ç ´',
          chapters: [
            { id: 'c1', title: 'ç¬¬ä¸€ç«  é™¨è½çš„å¤©æ‰', content: 'å°‘å¹´æœ›ç€æµ‹éªŒé­”çŸ³ç¢‘ï¼Œä¸Šé¢æ¸…æ™°çš„é•Œåˆ»ç€ä¸‰ä¸ªå­—ï¼šè§ç‚ã€‚\n\nç­‰çº§ï¼šä¸‰æ®µã€‚\n\næœ›ç€è¿™ä»¤äººå¤±æœ›çš„æˆç»©ï¼Œå°‘å¹´è‡ªå˜²çš„ç¬‘äº†ç¬‘ã€‚' },
            { id: 'c2', title: 'ç¬¬äºŒç«  åºŸæŸ´ä¸å¤©æ‰', content: 'â€œå”‰ï¼Œè¿™å­©å­ï¼ŒçœŸæ˜¯å¯æƒœäº†ã€‚â€\n\nâ€œæ˜¯å•Šï¼Œæ›¾ç»æ˜¯ä½•ç­‰çš„å¤©æ‰ï¼Œå¦‚ä»Šå´æ˜¯è¿™èˆ¬æ¨¡æ ·...â€' }
          ]
        },
        { 
          id: 'b2', 
          title: 'æ–—ç½—å¤§é™†', 
          author: 'å”å®¶ä¸‰å°‘', 
          cover: 'https://via.placeholder.com/60x80?text=æ–—ç½—',
          chapters: [
            { id: 'c1', title: 'ç¬¬ä¸€ç«  ç©¿è¶Šçš„å”å®¶ä¸‰å°‘', content: 'å”é—¨å¤–é—¨å¼Ÿå­å”ä¸‰ï¼Œå› å·å­¦å†…é—¨ç»å­¦ä¸ºå”é—¨æ‰€ä¸å®¹ï¼Œè·³å´–æ˜å¿—æ—¶å´å‘ç°æ²¡æœ‰æ­»ï¼Œåè€Œç©¿è¶Šåˆ°äº†å¦ä¸€ä¸ªä¸–ç•Œã€‚' }
          ]
        }
      ];

      const bookList = document.getElementById('bookList');
      bookList.innerHTML = '';
      mockBooks.forEach(book => {
        const item = document.createElement('div');
        item.className = 'book-item';
        // ä¿®å¤ï¼šä½¿ç”¨é—­åŒ…ç¡®ä¿ç‚¹å‡»æ—¶è·å–æ­£ç¡®çš„bookå¯¹è±¡
        item.onclick = (function(b) {
          return function() {
            openBook(b);
          };
        })(book);
        item.innerHTML = `
          <div class="book-cover">
            <img src="${book.cover}" alt="${book.title}">
          </div>
          <div class="book-info">
            <div class="book-title">${book.title}</div>
            <div class="book-author">ä½œè€…ï¼š${book.author}</div>
          </div>
        `;
        bookList.appendChild(item);
      });

      switchPage('pageBooks');
    }

    // ===================== æ–°å¢ï¼šä¹¦æ¶è”åŠ¨æ ¸å¿ƒåŠŸèƒ½ =====================
    
    /**
     * æ¸²æŸ“ä¹¦æ¶
     */
    function renderShelf() {
      const shelfList = document.getElementById('shelfList');
      if (shelfBooks.length === 0) {
        shelfList.innerHTML = '<p style="color: var(--text-secondary);">æš‚æ— ä¹¦ç±ï¼Œå»ä¹¦æºä¸­æ·»åŠ å§</p>';
        return;
      }

      shelfList.innerHTML = '';
      shelfBooks.forEach(book => {
        const item = document.createElement('div');
        item.className = 'book-item';
        item.onclick = () => openBookFromShelf(book);
        item.innerHTML = `
          <div class="book-cover">
            <img src="${book.cover}" alt="${book.title}">
          </div>
          <div class="book-info">
            <div class="book-title">${book.title}</div>
            <div class="book-author">ä½œè€…ï¼š${book.author}</div>
            <div class="book-progress">æ­£åœ¨é˜…è¯»ï¼š${book.lastChapterTitle}</div>
          </div>
        `;
        shelfList.appendChild(item);
      });
    }

    /**
     * åŠ å…¥ä¹¦æ¶ (ä¸é˜…è¯»å™¨è”åŠ¨)
     */
    function addToShelf() {
      if (!currentBook) return;

      // æ£€æŸ¥æ˜¯å¦å·²åœ¨ä¹¦æ¶
      const existIndex = shelfBooks.findIndex(b => b.id === currentBook.id);
      
      // æ„å»ºå¸¦è¿›åº¦çš„ä¹¦æ¶æ•°æ®
      const shelfBook = {
        ...currentBook,
        lastChapterIndex: currentChapterIndex,
        lastChapterTitle: currentChapters[currentChapterIndex].title
      };

      if (existIndex > -1) {
        // æ›´æ–°è¿›åº¦
        shelfBooks[existIndex] = shelfBook;
        showToast('é˜…è¯»è¿›åº¦å·²æ›´æ–°');
      } else {
        // æ–°å¢ä¹¦ç±
        shelfBooks.push(shelfBook);
        showToast('å·²åŠ å…¥ä¹¦æ¶');
      }

      // æŒä¹…åŒ–å¹¶åˆ·æ–°
      localStorage.setItem('shelfBooks', JSON.stringify(shelfBooks));
      renderShelf();
    }

    /**
     * ä»ä¹¦æ¶æ‰“å¼€ä¹¦ç± (æ¢å¤è¿›åº¦)
     */
    function openBookFromShelf(book) {
      currentBook = book;
      currentChapters = book.chapters;
      // å…³é”®è”åŠ¨ï¼šæ¢å¤ä¸Šæ¬¡é˜…è¯»çš„ç« èŠ‚
      currentChapterIndex = book.lastChapterIndex || 0;
      
      // ç›´æ¥åŠ è½½ç›®å½•å’Œç« èŠ‚
      renderCatalog();
      loadChapter(currentChapterIndex);
    }

    // ===================== é˜…è¯»ä¸ç›®å½•é€»è¾‘ (ä¼˜åŒ–è”åŠ¨) =====================
    function openBook(book) {
      currentBook = book;
      currentChapters = book.chapters;
      currentChapterIndex = 0;
      
      renderCatalog(); // æ‰“å¼€ä¹¦ç±æ—¶åŒæ—¶å‡†å¤‡ç›®å½•
      loadChapter(0);
    }

    function renderCatalog() {
      const catalogList = document.getElementById('catalogList');
      document.getElementById('catalogBookTitle').innerText = currentBook.title;
      
      let html = '';
      currentChapters.forEach((chapter, index) => {
        html += `<div class="catalog-item ${index === currentChapterIndex ? 'current' : ''}" onclick="loadChapter(${index})">${chapter.title}</div>`;
      });
      
      catalogList.innerHTML = html;
    }

    function loadChapter(index) {
      if (index < 0 || index >= currentChapters.length) {
        showToast(index < 0 ? 'å·²æ˜¯ç¬¬ä¸€ç« ' : 'å·²æ˜¯æœ€åä¸€ç« ');
è¿”å›ï¼›
}

currentChapterIndex=indexï¼›
Const chapter=currentChapters[index]ï¼›
      
Const readerContent=document.getElementById('readerContent')ï¼›
readerContent.innerHTML='
        <H3 é£æ ¼="æ–‡æœ¬å¯¹é½: ä¸­å¿ƒ; åº•è¾¹è·: 20PX;">${chapter.title}</H3>
        <p>${chapter.content.replace(/\n/gï¼Œ'</p><p>')}</p>
`;
      
// è”åŠ¨æ›´æ–°ç›®å½•é«˜äº®
æ–‡ä»¶ã€‚querySelectorAll('.catalog-item').foreach((itemï¼ŒI)=>{
item.classList.remove('current')ï¼›
if(i===index)item.classList.add('current')ï¼›
      });

switchPage('pageReader')ï¼›
    }

å‡½æ•°prevChapter(){loadChapter(currentChapterIndex-1)ï¼›}
å‡½æ•°nextchapter(){loadChapter(currentChapterIndex+1)ï¼›}

//=====================å·¥å…·å‡½æ•°(å¢å¼ºæ¸…é™¤ç¼“å­˜)=====================
å‡½æ•°initDarkMode(){/*ä¿æŒä¸å˜*/
if(isDarkMode){
document.body.classList.add('æ·±è‰²æ¨¡å¼')ï¼›
æ–‡ä»¶ã€‚getElementById('darkModeToggle').classListã€‚æ·»åŠ (â€œæ´»åŠ¨â€)ï¼›
      }
    }

å‡½æ•°toggleDarkMode(){/*ä¿æŒä¸å˜*/
isDarkMode=ï¼isDarkModeï¼›
æ–‡ä»¶ã€‚èº«ä½“ã€‚classList.Toggle('dark-mode'ï¼ŒisDarkMode)ï¼›
æ–‡ä»¶ã€‚getElementById('darkModeToggle').classListã€‚åˆ‡æ¢('active'ï¼ŒisDarkMode)ï¼›
localStorage.setItem('æ·±è‰²æ¨¡å¼'ï¼ŒisDarkMode)ï¼›
showToast(isDarkModeï¼Ÿ'å·²å¼€å¯å¤œé—´æ¨¡å¼'ï¼š'å·²å…³é—­å¤œé—´æ¨¡å¼')ï¼›
    }

å‡½æ•°clearCache(){/*å¢å¼ºï¼šåŒæ—¶æ¸…é™¤ä¹¦æ¶*/
if(ç¡®è®¤('è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä¹¦æºå’Œä¹¦æ¶æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼ ')){
localStorage.removeItem('sources')ï¼›
localStorage.removeItem('shelfBooks')ï¼›//è”åŠ¨æ¸…é™¤
æ¥æº=[]ï¼›
shelfBooks=[]ï¼›
RenderSource()ï¼›
renderShelf()ï¼›//è”åŠ¨åˆ·æ–°
showToast('ç¼“å­˜å·²æ¸…é™¤')ï¼›
      }
    }

å‡½æ•°showToast(msg){/*ä¿æŒä¸å˜*/
Const toast=document.getElementById('toast')ï¼›
toast.innerText=msgï¼›
toast.classList.add('show')ï¼›
setTimeout(()=>{
toast.classList.remove('show')ï¼›
}, 2000);
    }
</è„šæœ¬>
</body>
</html>


