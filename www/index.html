<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'unsafe-inline'; script-src 'unsafe-inline'">
  <title>å†°é˜…</title>
  <style>
    :root {
      --primary: #2575fc;
      --bg-light: #f5f5f5;
      --card-light: #ffffff;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border: #e0e0e0;
    }
    .dark-mode {
      --primary: #4080ff;
      --bg-light: #121212;
      --card-light: #1e1e1e;
      --text-primary: #e0e0e0;
      --text-secondary: #9e9e9e;
      --border: #333333;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
    body { 
      background: var(--bg-light); 
      color: var(--text-primary); 
      padding-bottom: 60px;
      transition: background 0.3s, color 0.3s;
    }
    
    .top-bar {
      position: fixed; top: 0; left: 0; width: 100%;
      height: 50px; background: var(--primary); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: bold;
      z-index: 10;
    }
    .page {
      margin-top: 60px; padding: 15px; display: none;
      min-height: calc(100vh - 110px);
    }
    .page.active { display: block; }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%;
      height: 50px; background: var(--card-light); border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 10;
      transition: background 0.3s, border-color 0.3s;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center;
      font-size: 12px; color: var(--text-secondary);
      cursor: pointer;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 20px; margin-bottom: 3px; }

    .card { 
      background: var(--card-light); 
      border-radius: 8px; 
      padding: 15px; 
      margin-bottom: 10px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s;
    }
    .btn {
      padding: 8px 16px; border: none; border-radius: 6px;
      background: var(--primary); color: #fff; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-danger { background: #dc3545; color: #fff; }
    .add-btn {
      position: fixed; bottom: 70px; right: 20px;
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary); color: #fff; border: none;
      font-size: 20px; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
      z-index: 99;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: var(--card-light); 
      padding: 20px; border-radius: 8px;
      width: 90%; max-width: 400px;
      border: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s;
      max-height: 85vh;
      overflow-y: auto;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-primary); }
    .form-control {
      width: 100%; padding: 10px; border: 1px solid var(--border);
      border-radius: 4px; font-size: 16px;
      background: var(--card-light);
      color: var(--text-primary);
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    .form-control::placeholder { color: var(--text-secondary); }
    .source-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .source-item:hover { background: rgba(0,0,0,0.02); }
    .toast {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 8px 16px; border-radius: 20px;
      display: none;
      z-index: 999;
    }
    .toast.show { display: block; }

    .loading {
      text-align: center; padding: 40px 0; color: var(--text-secondary);
    }
    .loading::after {
      content: ''; display: block; width: 30px; height: 30px; margin: 20px auto;
      border: 3px solid var(--border); border-top-color: var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .book-item {
      display: flex; gap: 10px; padding: 10px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .book-cover {
      width: 60px; height: 80px; background: #eee; border-radius: 4px;
      overflow: hidden; flex-shrink: 0;
    }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-info { flex: 1; }
    .book-title { font-weight: bold; margin-bottom: 4px; }
    .book-author, .book-progress { font-size: 12px; color: var(--text-secondary); }

    .reader-page { padding: 20px; line-height: 1.8; font-size: 16px; }
    .reader-content { margin-bottom: 60px; }
    .reader-toolbar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.7); color: #fff;
      display: flex; justify-content: space-around; padding: 10px 0; z-index: 90;
    }
    .reader-tool {
      display: flex; flex-direction: column; align-items: center; font-size: 12px; cursor: pointer;
    }

    .catalog-page { padding: 0; }
    .catalog-header {
      padding: 15px; background: var(--primary); color: #fff;
      display: flex; justify-content: space-between; align-items: center;
    }
    .catalog-list {
      padding: 15px; height: calc(100vh - 110px); overflow-y: auto;
    }
    .catalog-item {
      padding: 8px 0; border-bottom: 1px solid var(--border); cursor: pointer;
    }
    .catalog-item.current { color: var(--primary); font-weight: bold; }

    .setting-item {
      display: flex; justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .setting-item:last-child { border-bottom: none; }
    .setting-desc {
      font-size: 12px; color: var(--text-secondary);
    }
    .toggle {
      position: relative;
      width: 44px; height: 22px;
      background: var(--border);
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.active { background: var(--primary); }
    .toggle::after {
      content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%;
      background: #fff; top: 2px; left: 2px; transition: left 0.3s;
    }
    .toggle.active::after { left: 24px; }

    .import-type-section textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      background: var(--card-light);
      color: var(--text-primary);
    }

    .import-status {
      margin-top: 10px;
      font-size: 12px;
      padding: 10px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
    }

    /* ============ å¢å¼ºçš„åŠ¨ç”»å’Œè¿‡æ¸¡ ============ */
    @keyframes slideUp {
      from { 
        transform: translateY(30px); 
        opacity: 0; 
      }
      to { 
        transform: translateY(0); 
        opacity: 1; 
      }
    }

    @keyframes fadeIn {
      from { 
        opacity: 0; 
      }
      to { 
        opacity: 1; 
      }
    }

    @keyframes slideDown {
      from { 
        transform: translateY(-30px); 
        opacity: 0; 
      }
      to { 
        transform: translateY(0); 
        opacity: 1; 
      }
    }

    @keyframes slideInRight {
      from { 
        transform: translateX(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0); 
        opacity: 1; 
      }
    }

    @keyframes slideInLeft {
      from { 
        transform: translateX(-100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0); 
        opacity: 1; 
      }
    }

    @keyframes pulse {
      0%, 100% { 
        opacity: 1; 
      }
      50% { 
        opacity: 0.7; 
      }
    }

    @keyframes bounce {
      0%, 100% { 
        transform: translateY(0); 
      }
      50% { 
        transform: translateY(-10px); 
      }
    }

    @keyframes fadeOut {
      from { 
        opacity: 1; 
      }
      to { 
        opacity: 0; 
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes rotateIn {
      from {
        transform: rotate(-10deg);
        opacity: 0;
      }
      to {
        transform: rotate(0deg);
        opacity: 1;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    @keyframes flip {
      0% {
        transform: perspective(400px) rotateY(0);
        opacity: 1;
      }
      100% {
        transform: perspective(400px) rotateY(360deg);
        opacity: 1;
      }
    }

    .page {
      animation: slideUp 0.4s ease-out;
    }

    .page.active {
      animation: slideUp 0.4s ease-out;
    }

    .modal {
      animation: fadeIn 0.3s ease-out;
    }

    .modal.show {
      animation: fadeIn 0.3s ease-out;
    }

    .card {
      animation: slideUp 0.5s ease-out;
    }

    .book-item {
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .book-item:active {
      transform: scale(0.95);
      background: rgba(37, 117, 252, 0.08);
    }

    .book-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn {
      transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
      position: relative;
      overflow: hidden;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .btn:active {
      transform: scale(0.92);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) inset;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 117, 252, 0.3);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease-out, height 0.6s ease-out;
    }

    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    /* é¡µé¢åˆ‡æ¢æ—¶çš„è¿‡æ¸¡ */
    .page {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .page:not(.active) {
      opacity: 0;
      pointer-events: none;
    }

    .page.active {
      opacity: 1;
    }

    /* åˆ—è¡¨é¡¹çš„åŠ¨ç”» */
    .source-item, .book-item, .catalog-item {
      animation: slideUp 0.3s ease-out;
    }

    .source-item:hover, .catalog-item:hover {
      background: rgba(37, 117, 252, 0.08);
      padding-left: 5px;
      transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    /* åŠ è½½åŠ¨ç”»å¢å¼º */
    .loading {
      animation: fadeIn 0.5s ease-out;
    }

    .loading::after {
      animation: spin 1.5s linear infinite;
    }

    /* å¿«é€Ÿåé¦ˆ */
    .toast {
      animation: slideUp 0.3s ease-out;
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .toast.show {
      animation: slideUp 0.3s ease-out;
    }

    /* é˜…è¯»å™¨å¢å¼º */
    .reader-content {
      animation: slideInLeft 0.4s ease-out;
    }

    .reader-toolbar {
      animation: slideUp 0.3s ease-out;
    }

    .reader-tool {
      transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .reader-tool:active {
      transform: scale(0.85);
      color: var(--primary);
    }

    .reader-tool:hover {
      transform: scale(1.1);
    }

    /* è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ */
    .form-control {
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 12px rgba(37, 117, 252, 0.3);
      outline: none;
      transform: scale(1.02);
    }

    /* ä¸‹æ‹‰èœå•å¢å¼º */
    select.form-control {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 1.5em 1.5em;
      padding-right: 2.5em;
    }

    /* ADDæŒ‰é’®å¢å¼ºåŠ¨ç”» */
    .add-btn {
      animation: scaleIn 0.4s ease-out;
    }

    .add-btn:hover {
      transform: rotate(90deg) scale(1.1);
    }

    .add-btn:active {
      transform: rotate(90deg) scale(0.95);
    }

    /* ç›®å½•é¡¹è¿‡æ¸¡ */
    .catalog-item.current {
      animation: pulse 0.5s ease-out;
    }

    /* å¼€å…³åŠ¨ç”» */
    .toggle {
      animation: scaleIn 0.3s ease-out;
    }

    .toggle.active {
      animation: rotateIn 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="top-bar">å†°é˜… Â· ä¹¦æºç®¡ç†</div>

  <!-- 1. ä¹¦æºç®¡ç†é¡µ -->
  <div id="pageSource" class="page active">
    <div class="card">
      <h3 style="margin-bottom: 10px; font-size: 16px;">ä¹¦æºåˆ—è¡¨</h3>
      <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <button class="btn" onclick="openImportModal()" style="flex: 1; font-size: 13px;">ğŸ“¥ å¯¼å…¥</button>
        <button class="btn btn-secondary" onclick="openModal()" style="flex: 1; font-size: 13px;">â• æ–°å¢</button>
      </div>
      <div id="sourceList"></div>
    </div>
    <button class="add-btn" onclick="openModal()">+</button>
  </div>

  <!-- 2. ä¹¦æ¶é¡µ -->
  <div id="pageShelf" class="page">
    <div class="card">
      <h3 style="font-size: 16px; margin-bottom: 15px;">æˆ‘çš„ä¹¦æ¶</h3>
      <div id="shelfList">
        <p style="color: var(--text-secondary);">æš‚æ— ä¹¦ç±ï¼Œå»ä¹¦æºä¸­æ·»åŠ å§</p>
      </div>
    </div>
  </div>

  <!-- 3. ä¹¦ç±åˆ—è¡¨é¡µ -->
  <div id="pageBooks" class="page">
    <div class="card">
      <h3 style="font-size: 16px; margin-bottom: 15px;">
        <span id="sourceBookTitle">ä¹¦æºä¹¦ç±</span>
        <button class="btn btn-secondary" style="float: right; font-size: 12px;" onclick="switchPage('pageSource')">è¿”å›</button>
      </h3>
      <div id="bookList"></div>
    </div>
  </div>

  <!-- 4. é˜…è¯»å™¨é¡µ -->
  <div id="pageReader" class="page reader-page">
    <div id="readerContent" class="reader-content"></div>
    <div class="reader-toolbar">
      <div class="reader-tool" onclick="prevChapter()">
        <i>â¬…ï¸</i>
        <span>ä¸Šä¸€ç« </span>
      </div>
      <div class="reader-tool" onclick="addToShelf()">
        <i>ğŸ“š</i>
        <span>åŠ ä¹¦æ¶</span>
      </div>
      <div class="reader-tool" onclick="switchPage('pageCatalog')">
        <i>â˜°</i>
        <span>ç›®å½•</span>
      </div>
      <div class="reader-tool" onclick="nextChapter()">
        <i>â¡ï¸</i>
        <span>ä¸‹ä¸€ç« </span>
      </div>
    </div>
  </div>

  <!-- 5. ç›®å½•é¡µ -->
  <div id="pageCatalog" class="page catalog-page">
    <div class="catalog-header">
      <span id="catalogBookTitle">ç›®å½•</span>
      <button class="btn btn-secondary" style="font-size: 12px;" onclick="switchPage('pageReader')">è¿”å›</button>
    </div>
    <div id="catalogList" class="catalog-list">
      <div class="loading">åŠ è½½ç›®å½•ä¸­...</div>
    </div>
  </div>

  <!-- 6. æ›´å¤šé¡µ -->
  <div id="pageMore" class="page">
    <div class="card">
      <h3 style="font-size: 16px; margin-bottom: 15px;">ç³»ç»Ÿè®¾ç½®</h3>
      <div class="setting-item" onclick="toggleDarkMode()">
        <span>å¤œé—´æ¨¡å¼</span>
        <div class="toggle" id="darkModeToggle"></div>
      </div>
      <div class="setting-item" onclick="clearCache()">
        <span>æ¸…é™¤ç¼“å­˜</span>
        <span class="setting-desc">åˆ é™¤æ‰€æœ‰æ•°æ®</span>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘ä¹¦æºå¼¹çª— -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle" style="margin-bottom: 15px; font-size: 18px;">æ·»åŠ ä¹¦æº</h3>
      <input type="hidden" id="sourceId">
      <div class="form-group">
        <label>ä¹¦æºåç§°</label>
        <input type="text" id="sourceName" class="form-control" placeholder="ä¾‹å¦‚ï¼šç¬”è¶£é˜">
      </div>
      <div class="form-group">
        <label>ä¹¦æºåœ°å€</label>
        <input type="text" id="sourceUrl" class="form-control" placeholder="https://xxx.com/api/books.json">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn" onclick="saveSource()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å¯¼å…¥ä¹¦æºå¼¹çª— -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <h3 style="margin-bottom: 15px; font-size: 18px;">å¯¼å…¥ä¹¦æº</h3>
      <div class="form-group">
        <label>é€‰æ‹©å¯¼å…¥æ–¹å¼</label>
        <select id="importType" class="form-control" onchange="updateImportUI()">
          <option value="json">JSONæ ¼å¼</option>
          <option value="xml">XMLæ ¼å¼</option>
          <option value="text">æ–‡æœ¬åˆ—è¡¨</option>
          <option value="url">ä»URLå¯¼å…¥</option>
        </select>
      </div>
      
      <div id="importJson" class="import-type-section">
        <div class="form-group">
          <label>ç²˜è´´JSONæ•°æ®</label>
          <textarea id="jsonInput" class="form-control" placeholder='[{"name":"ç¬”è¶£é˜","url":"https://..."},...]' style="height: 100px;"></textarea>
        </div>
      </div>
      
      <div id="importXml" class="import-type-section" style="display:none;">
        <div class="form-group">
          <label>ç²˜è´´XMLæ•°æ®</label>
          <textarea id="xmlInput" class="form-control" placeholder='&lt;sources&gt;&lt;source&gt;&lt;name&gt;ä¹¦æº&lt;/name&gt;&lt;url&gt;...&lt;/url&gt;&lt;/source&gt;&lt;/sources&gt;' style="height: 100px;"></textarea>
        </div>
      </div>
      
      <div id="importText" class="import-type-section" style="display:none;">
        <div class="form-group">
          <label>æ–‡æœ¬åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª: åç§°|URL)</label>
          <textarea id="textInput" class="form-control" placeholder='ç¬”è¶£é˜|https://www.biquge.io' style="height: 100px;"></textarea>
        </div>
      </div>
      
      <div id="importUrl" class="import-type-section" style="display:none;">
        <div class="form-group">
          <label>æ•°æ®æºURL</label>
          <input type="text" id="sourceDataUrl" class="form-control" placeholder="https://example.com/sources.json">
        </div>
        <div class="form-group">
          <label>æ•°æ®æ ¼å¼</label>
          <select id="urlFormat" class="form-control">
            <option value="json">JSON</option>
            <option value="xml">XML</option>
            <option value="text">æ–‡æœ¬åˆ—è¡¨</option>
          </select>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
        <button class="btn" onclick="executeImport()">å¯¼å…¥</button>
      </div>
      <div id="importStatus" class="import-status" style="display:none;"></div>
    </div>
  </div>

  <!-- æç¤ºæ¡† -->
  <div id="toast" class="toast"></div>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="switchPage('pageShelf')">
      <i>ğŸ“š</i>
      <span>ä¹¦æ¶</span>
    </div>
    <div class="nav-item active" onclick="switchPage('pageSource')">
      <i>âš™ï¸</i>
      <span>ä¹¦æº</span>
    </div>
    <div class="nav-item" onclick="switchPage('pageMore')">
      <i>â˜°</i>
      <span>æ›´å¤š</span>
    </div>
  </div>

  <script>
    // ===================== å…¨å±€å˜é‡ =====================
    let sources = JSON.parse(localStorage.getItem('sources') || '[]');
    let currentEditId = null;
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    let currentSource = null;
    let currentBook = null;
    let currentChapters = [];
    let currentChapterIndex = 0;
    let shelfBooks = JSON.parse(localStorage.getItem('shelfBooks') || '[]');
    let booksCache = {};
    let passive = { passive: true };

    // ===================== åˆå§‹åŒ– =====================
    window.onload = function() {
      renderSources();
      renderShelf();
      initDarkMode();
      setupGestureHandlers();
      setupKeyboardShortcuts();
      loadProgressTracking();
    };

    // ===================== æ‰‹åŠ¿å¤„ç† =====================
    function setupGestureHandlers() {
      let touchStartX = 0;
      let touchStartY = 0;
      let touchStartTime = 0;

      document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
      }, passive);

      document.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        const touchEndTime = Date.now();
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;
        const duration = touchEndTime - touchStartTime;

        // æ°´å¹³æ»‘åŠ¨æ£€éªŒï¼ˆå¿«é€Ÿæ»‘åŠ¨ï¼‰
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50 && duration < 500) {
          if (diffX > 0) {
            // å‘å³æ»‘åŠ¨ - ä¸Šä¸€ç« 
            if (document.getElementById('pageReader').classList.contains('active')) {
              prevChapter();
            }
          } else {
            // å‘å·¦æ»‘åŠ¨ - ä¸‹ä¸€ç« 
            if (document.getElementById('pageReader').classList.contains('active')) {
              nextChapter();
            }
          }
        }
      }, passive);

      // å¤„ç†é•¿æŒ‰
      document.addEventListener('touchstart', (e) => {
        const target = e.target;
        if (target.classList.contains('book-item') || target.closest('.book-item')) {
          const longPressTimer = setTimeout(() => {
            showToast('ğŸ’¡ æç¤ºï¼šç‚¹å‡»æ‰“å¼€ä¹¦ç±ï¼Œå·¦å³æ»‘åŠ¨ç¿»é¡µ');
          }, 1000);
          
          target.addEventListener('touchend', () => clearTimeout(longPressTimer), { once: true });
        }
      }, passive);
    }

    // ===================== é”®ç›˜å¿«æ·é”® =====================
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        const isReader = document.getElementById('pageReader').classList.contains('active');
        const isCatalog = document.getElementById('pageCatalog').classList.contains('active');
        const isModal = document.getElementById('modal').classList.contains('show') || 
                       document.getElementById('importModal').classList.contains('show');
        
        // é¿å…åœ¨æ¨¡æ€æ¡†ä¸­å¤„ç†å¿«æ·é”®
        if (isModal) return;
        
        if (isReader || isCatalog) {
          if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
            e.preventDefault();
            prevChapter();
          } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
            e.preventDefault();
            nextChapter();
          } else if (e.key === 'Escape' || e.key === 'q' || e.key === 'Q') {
            if (isReader) {
              switchPage('pageCatalog');
            } else {
              switchPage('pageReader');
            }
          } else if (e.key === ' ') {
            // ç©ºæ ¼ç¿»é¡µ
            e.preventDefault();
            nextChapter();
          } else if (e.key === 'b' || e.key === 'B') {
            // B é”®åŠ ä¹¦æ¶
            addToShelf();
          }
        }
      });
    }

    // ===================== è¿›åº¦è·Ÿè¸ª =====================
    function loadProgressTracking() {
      const progress = JSON.parse(localStorage.getItem('readingProgress') || '{}');
      window.readingProgress = progress;
    }

    function saveReadingProgress() {
      if (currentBook && currentChapters.length > 0) {
        window.readingProgress[currentBook.id] = {
          bookTitle: currentBook.title,
          chapterIndex: currentChapterIndex,
          chapterTitle: currentChapters[currentChapterIndex]?.title,
          timestamp: Date.now()
        };
        localStorage.setItem('readingProgress', JSON.stringify(window.readingProgress));
      }
    }

    // ===================== é¡µé¢åˆ‡æ¢ =====================
    function switchPage(pageId) {
      const pages = document.querySelectorAll('.page');
      const targetPage = document.getElementById(pageId);
      let activePage = null;
      
      // æ‰¾åˆ°å½“å‰æ´»è·ƒé¡µé¢
      pages.forEach(page => {
        if (page.classList.contains('active')) {
          activePage = page;
        }
      });
      
      // å¦‚æœå·²ç»åœ¨è¯¥é¡µé¢ï¼Œåˆ™ä¸åˆ‡æ¢
      if (activePage === targetPage) return;
      
      // å¤„ç†é€€å‡ºåŠ¨ç”»
      if (activePage) {
        activePage.style.animation = 'slideDown 0.3s ease-out forwards';
        activePage.style.pointerEvents = 'none';
      }
      
      // å¤„ç†è¿›å…¥åŠ¨ç”»
      setTimeout(() => {
        pages.forEach(page => {
          page.classList.remove('active');
          page.style.animation = '';
          page.style.pointerEvents = '';
        });
        targetPage.classList.add('active');
        targetPage.style.animation = 'slideUp 0.4s ease-out';
        
        // åœ¨æŸäº›é¡µé¢ä¸Šåº”ç”¨ä¸åŒçš„åŠ¨ç”»
        if (pageId === 'pageReader') {
          targetPage.style.animation = 'slideInLeft 0.4s ease-out';
        } else if (pageId === 'pageCatalog') {
          targetPage.style.animation = 'slideInRight 0.4s ease-out';
        }
      }, 100);
      
      // æ›´æ–°å¯¼èˆªæ 
      updateNavBar(pageId);
      updateTopBar(pageId);
      
      // è§¦å‘é¡µé¢è¿›å…¥äº‹ä»¶
      if (pageId === 'pageShelf') renderShelf();
      if (pageId === 'pageMore') initSettings();
    }

    function updateNavBar(pageId) {
      document.querySelectorAll('.nav-item').forEach(item => {
        const isActive = item.querySelector('span').textContent.includes(getPageLabel(pageId));
        item.classList.toggle('active', isActive);
        if (isActive) {
          item.style.animation = 'bounce 0.4s ease-out';
        }
      });
    }

    function updateTopBar(pageId) {
      const topBar = document.querySelector('.top-bar');
      const titles = {
        'pageSource': 'ğŸ“– å†°é˜… Â· ä¹¦æºç®¡ç†',
        'pageShelf': 'ğŸ“š å†°é˜… Â· æˆ‘çš„ä¹¦æ¶',
        'pageBooks': 'ğŸ” å†°é˜… Â· ä¹¦ç±åˆ—è¡¨',
        'pageReader': 'ğŸ“– å†°é˜… Â· é˜…è¯»ä¸­',
        'pageCatalog': 'â˜° å†°é˜… Â· ç« èŠ‚ç›®å½•',
        'pageMore': 'âš™ï¸ å†°é˜… Â· æ›´å¤šåŠŸèƒ½'
      };
      
      topBar.style.opacity = '0.5';
      topBar.style.transition = 'opacity 0.2s ease';
      
      setTimeout(() => {
        topBar.innerText = titles[pageId] || 'å†°é˜…';
        topBar.style.opacity = '1';
      }, 100);
    }

    function getPageLabel(pageId) {
      const labels = {
        'pageSource': 'ä¹¦æº',
        'pageShelf': 'ä¹¦æ¶',
        'pageBooks': 'ä¹¦ç±',
        'pageCatalog': 'ç›®å½•',
        'pageMore': 'æ›´å¤š'
      };
      return labels[pageId] || '';
    }

    // ===================== ä¹¦æºç®¡ç† =====================
    function renderSources() {
      const sourceList = document.getElementById('sourceList');
      if (sources.length === 0) {
        sourceList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 30px 0;">ğŸ“¥ æš‚æ— ä¹¦æºï¼Œç‚¹å‡»å¯¼å…¥æˆ–æ–°å¢</p>';
        return;
      }
      sourceList.innerHTML = '';
      sources.forEach((source, index) => {
        const item = document.createElement('div');
        item.className = 'source-item';
        item.style.animation = `slideUp 0.3s ease-out ${index * 50}ms both`;
        item.onclick = () => loadBooksFromSource(source);
        
        item.innerHTML = `
          <div style="flex: 1;">
            <strong style="font-size: 14px;">${source.name}</strong>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; word-break: break-all;">${source.url}</p>
          </div>
          <div style="display: flex; gap: 5px; flex-shrink: 0; margin-left: 10px;">
            <button class="btn btn-secondary" onclick="event.stopPropagation(); editSource('${source.id}')" style="padding: 5px 10px; font-size: 12px;">âœï¸</button>
            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteSource('${source.id}')" style="padding: 5px 10px; font-size: 12px;">ğŸ—‘ï¸</button>
          </div>
        `;
        sourceList.appendChild(item);
      });
    }

    function openModal() {
      currentEditId = null;
      document.getElementById('modalTitle').innerText = 'æ·»åŠ ä¹¦æº';
      document.getElementById('sourceId').value = '';
      document.getElementById('sourceName').value = '';
      document.getElementById('sourceUrl').value = '';
      
      const modal = document.getElementById('modal');
      modal.classList.add('show');
      
      // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
      setTimeout(() => {
        document.getElementById('sourceName').focus();
      }, 300);
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      modal.style.animation = 'fadeOut 0.3s ease-out forwards';
      
      setTimeout(() => {
        modal.classList.remove('show');
        modal.style.animation = '';
      }, 300);
    }

    function saveSource() {
      const id = document.getElementById('sourceId').value || Date.now().toString();
      const name = document.getElementById('sourceName').value.trim();
      const url = document.getElementById('sourceUrl').value.trim();

      if (!name || !url) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
      }

      if (currentEditId) {
        sources = sources.map(s => s.id === currentEditId ? { id, name, url } : s);
      } else {
        sources.push({ id, name, url });
      }

      localStorage.setItem('sources', JSON.stringify(sources));
      renderSources();
      closeModal();
      showToast('ä¿å­˜æˆåŠŸ');
    }

    function editSource(id) {
      const source = sources.find(s => s.id === id);
      if (!source) return;
      currentEditId = id;
      document.getElementById('modalTitle').innerText = 'ç¼–è¾‘ä¹¦æº';
      document.getElementById('sourceId').value = source.id;
      document.getElementById('sourceName').value = source.name;
      document.getElementById('sourceUrl').value = source.url;
      document.getElementById('modal').classList.add('show');
    }

    function deleteSource(id) {
      if (confirm('ç¡®å®šåˆ é™¤è¯¥ä¹¦æºå—ï¼Ÿ')) {
        sources = sources.filter(s => s.id !== id);
        localStorage.setItem('sources', JSON.stringify(sources));
        renderSources();
        showToast('åˆ é™¤æˆåŠŸ');
      }
    }

    // ===================== å¯¼å…¥åŠŸèƒ½ =====================
    function openImportModal() {
      document.getElementById('importType').value = 'json';
      updateImportUI();
      document.getElementById('jsonInput').value = '';
      document.getElementById('xmlInput').value = '';
      document.getElementById('textInput').value = '';
      document.getElementById('sourceDataUrl').value = '';
      document.getElementById('importStatus').style.display = 'none';
      
      const modal = document.getElementById('importModal');
      modal.classList.add('show');
      
      setTimeout(() => {
        document.getElementById('jsonInput').focus();
      }, 300);
    }

    function closeImportModal() {
      const modal = document.getElementById('importModal');
      modal.style.animation = 'fadeOut 0.3s ease-out forwards';
      
      setTimeout(() => {
        modal.classList.remove('show');
        modal.style.animation = '';
      }, 300);
    }

    function updateImportUI() {
      const type = document.getElementById('importType').value;
      document.getElementById('importJson').style.display = type === 'json' ? 'block' : 'none';
      document.getElementById('importXml').style.display = type === 'xml' ? 'block' : 'none';
      document.getElementById('importText').style.display = type === 'text' ? 'block' : 'none';
      document.getElementById('importUrl').style.display = type === 'url' ? 'block' : 'none';
    }

    async function executeImport() {
      const type = document.getElementById('importType').value;
      const statusEl = document.getElementById('importStatus');
      statusEl.style.display = 'block';
      statusEl.innerText = 'â³ å¤„ç†ä¸­...';
      statusEl.style.color = 'var(--text-secondary)';
      statusEl.style.animation = 'pulse 1.5s ease-in-out infinite';

      try {
        let importedSources = [];

        if (type === 'json') {
          const data = JSON.parse(document.getElementById('jsonInput').value);
          importedSources = Array.isArray(data) ? data : (data.sources || data.list || []);
        } else if (type === 'xml') {
          const xml = document.getElementById('xmlInput').value;
          importedSources = parseImportXML(xml);
        } else if (type === 'text') {
          const text = document.getElementById('textInput').value;
          importedSources = parseImportText(text);
        } else if (type === 'url') {
          const url = document.getElementById('sourceDataUrl').value;
          const format = document.getElementById('urlFormat').value;
          importedSources = await loadFromURL(url, format);
        }

        // æ·»åŠ å¯¼å…¥çš„ä¹¦æº
        let addedCount = 0;
        importedSources.forEach(src => {
          if (src.name && src.url) {
            sources.push({
              id: Date.now().toString() + Math.random(),
              name: src.name || src.title || 'æœªçŸ¥',
              url: src.url || src.link || ''
            });
            addedCount++;
          }
        });

        localStorage.setItem('sources', JSON.stringify(sources));
        renderSources();
        
        statusEl.style.animation = '';
        statusEl.style.color = '#27ae60';
        statusEl.innerText = `âœ“ æˆåŠŸå¯¼å…¥ ${addedCount} ä¸ªä¹¦æº`;
        
        setTimeout(() => {
          closeImportModal();
          showToast(`âœ“ æˆåŠŸå¯¼å…¥ ${addedCount} ä¸ªä¹¦æº`);
        }, 1500);
      } catch (error) {
        statusEl.style.animation = '';
        statusEl.style.color = '#dc3545';
        statusEl.innerText = 'âŒ ' + (error.message || 'å¯¼å…¥å¤±è´¥');
      }
    }

    function parseImportXML(xmlText) {
      const sources = [];
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
      
      if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
        throw new Error('XMLæ ¼å¼é”™è¯¯');
      }

      const sourceElems = xmlDoc.getElementsByTagName('source') || xmlDoc.getElementsByTagName('item');
      for (let elem of sourceElems) {
        sources.push({
          name: elem.getElementsByTagName('name')[0]?.textContent || elem.getElementsByTagName('title')[0]?.textContent || 'æœªçŸ¥',
          url: elem.getElementsByTagName('url')[0]?.textContent || elem.getElementsByTagName('address')[0]?.textContent || ''
        });
      }
      return sources;
    }

    function parseImportText(text) {
      const sources = [];
      const lines = text.trim().split('\n');
      lines.forEach(line => {
        const parts = line.split('|').length > 1 ? line.split('|') : line.split('\t');
        if (parts.length >= 2) {
          sources.push({
            name: parts[0].trim(),
            url: parts[1].trim()
          });
        }
      });
      return sources;
    }

    async function loadFromURL(url, format) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const text = await response.text();
      if (format === 'json') {
        const data = JSON.parse(text);
        return Array.isArray(data) ? data : (data.sources || data.list || []);
      } else if (format === 'xml') {
        return parseImportXML(text);
      } else {
        return parseImportText(text);
      }
    }

    // ===================== ä¹¦ç±åŠ è½½ =====================
    async function loadBooksFromSource(source) {
      currentSource = source;
      document.getElementById('sourceBookTitle').innerText = `${source.name} - åŠ è½½ä¸­...`;
      
      const bookList = document.getElementById('bookList');
      bookList.innerHTML = '<div class="loading">åŠ è½½ä¹¦ç±ä¸­...</div>';
      switchPage('pageBooks');
      
      try {
        if (booksCache[source.id]) {
          displayBooks(booksCache[source.id]);
          return;
        }
        
        const response = await fetch(source.url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json, application/xml, text/plain',
            'User-Agent': 'Mozilla/5.0 (Android)'
          }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const contentType = response.headers.get('content-type') || '';
        let data;
        
        if (contentType.includes('json')) {
          data = await response.json();
        } else if (contentType.includes('xml')) {
          const text = await response.text();
          data = parseXML(text);
        } else {
          const text = await response.text();
          try {
            data = JSON.parse(text);
          } catch (e) {
            try {
              data = parseXML(text);
            } catch (e2) {
              data = parseTextBooks(text);
            }
          }
        }
        
        booksCache[source.id] = data;
        displayBooks(data);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        showErrorBooks(error);
      }
    }

    function displayBooks(books) {
      const bookList = document.getElementById('bookList');
      
      if (!Array.isArray(books)) {
        books = books.books || books.source || books.list || [];
      }
      
      if (books.length === 0) {
        bookList.innerHTML = '<p style="color: var(--text-secondary);">æœªæ‰¾åˆ°ä¹¦ç±</p>';
        return;
      }
      
      document.getElementById('sourceBookTitle').innerText = `${currentSource.name} - ${books.length}æœ¬ä¹¦`;
      bookList.innerHTML = '';
      
      books.forEach((book, index) => {
        const item = document.createElement('div');
        item.className = 'book-item';
        
        // æ·»åŠ å»¶è¿ŸåŠ¨ç”»
        item.style.animation = `slideUp 0.3s ease-out ${index * 50}ms both`;
        item.onclick = () => openBook(book);
        
        const title = book.title || book.name || 'æœªçŸ¥ä¹¦å';
        const author = book.author || book.writer || 'æœªçŸ¥ä½œè€…';
        const cover = book.cover || book.image || book.img || 'https://via.placeholder.com/60x80?text=no+cover';
        
        // æ·»åŠ åŠ è½½ä¸­çš„å ä½ç¬¦
        item.innerHTML = `
          <div class="book-cover" style="position: relative;">
            <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.1); border-radius: 4px; animation: pulse 1.5s ease-in-out infinite;"></div>
            <img src="${cover}" alt="${title}" onerror="this.src='https://via.placeholder.com/60x80?text=book'" loading="lazy">
          </div>
          <div class="book-info">
            <div class="book-title">${title}</div>
            <div class="book-author">ä½œè€…ï¼š${author}</div>
            <div class="book-progress">ç‚¹å‡»é˜…è¯»</div>
          </div>
        `;
        bookList.appendChild(item);
      });
    }

    function showErrorBooks(error) {
      const bookList = document.getElementById('bookList');
      bookList.innerHTML = `
        <div style="padding: 20px; text-align: center; color: #dc3545;">
          <p style="margin-bottom: 10px;">ğŸ“¥ åŠ è½½å¤±è´¥</p>
          <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">${error.message}</p>
          <button class="btn btn-secondary" onclick="switchPage('pageSource')">è¿”å›</button>
        </div>
      `;
      document.getElementById('sourceBookTitle').innerText = `${currentSource.name} - åŠ è½½å¤±è´¥`;
    }

    // ===================== XMLè§£æ =====================
    function parseXML(xmlText) {
      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
          throw new Error('XMLæ ¼å¼é”™è¯¯');
        }
        
        const books = [];
        const bookElements = xmlDoc.getElementsByTagName('book') || xmlDoc.getElementsByTagName('item');
        
        for (let elem of bookElements) {
          const book = {
            id: elem.getAttribute('id') || `book_${Date.now()}`,
            title: elem.getElementsByTagName('title')[0]?.textContent || elem.getElementsByTagName('name')[0]?.textContent || 'æœªçŸ¥',
            author: elem.getElementsByTagName('author')[0]?.textContent || 'æœªçŸ¥',
            cover: elem.getElementsByTagName('cover')[0]?.textContent || '',
            chapters: parseXMLChapters(elem)
          };
          if (book.title) books.push(book);
        }
        
        return books;
      } catch (error) {
        throw new Error('XMLè§£æå¤±è´¥');
      }
    }

    function parseXMLChapters(bookElem) {
      const chapters = [];
      const chapterElements = bookElem.getElementsByTagName('chapter');
      
      for (let elem of chapterElements) {
        chapters.push({
          id: elem.getAttribute('id') || `ch_${Date.now()}`,
          title: elem.getElementsByTagName('title')[0]?.textContent || 'æœªåç« ',
          content: elem.getElementsByTagName('content')[0]?.textContent || 'æš‚æ— å†…å®¹'
        });
      }
      
      return chapters;
    }

    function parseTextBooks(text) {
      const books = [];
      const lines = text.trim().split('\n').filter(l => l.trim());
      
      lines.forEach((line, index) => {
        const parts = line.split('|').length > 1 ? line.split('|') : line.split('\t');
        if (parts.length >= 2) {
          books.push({
            id: `book_${index}`,
            title: parts[0].trim(),
            author: parts[2] ? parts[2].trim() : 'æœªçŸ¥ä½œè€…',
            chapters: genChapters(parts[0].trim())
          });
        }
      });
      
      return books;
    }

    function genChapters(bookTitle) {
      return [
        { id: 'c1', title: 'ç¬¬ä¸€ç«  å¼€å§‹', content: `æ¬¢è¿é˜…è¯»ã€Š${bookTitle}ã€‹\n\nè¿™æ˜¯ç¤ºä¾‹ç« èŠ‚ã€‚` }
      ];
    }

    // ===================== ä¹¦ç±é˜…è¯» =====================
    async function openBook(book) {
      currentBook = book;
      
      if (book.chapters && book.chapters.length > 0) {
        currentChapters = book.chapters;
        currentChapterIndex = 0;
        renderCatalog();
        loadChapter(0);
        return;
      }
      
      currentChapters = genChapters(book.title);
      currentChapterIndex = 0;
      renderCatalog();
      loadChapter(0);
    }

    function renderCatalog() {
      const catalogList = document.getElementById('catalogList');
      document.getElementById('catalogBookTitle').innerText = currentBook.title;
      
      catalogList.innerHTML = '';
      currentChapters.forEach((chapter, index) => {
        const item = document.createElement('div');
        item.className = `catalog-item ${index === currentChapterIndex ? 'current' : ''}`;
        item.style.animation = `slideUp 0.3s ease-out ${index * 30}ms both`;
        item.textContent = chapter.title;
        item.onclick = () => loadChapter(index);
        
        // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
        item.style.transition = 'all 0.2s ease';
        catalogList.appendChild(item);
      });
    }

    function loadChapter(index) {
      if (index < 0 || index >= currentChapters.length) {
        showToast(index < 0 ? 'â¬…ï¸ å·²æ˜¯ç¬¬ä¸€ç« ' : 'â¡ï¸ å·²æ˜¯æœ€åä¸€ç« ', 1500, 'warning');
        return;
      }

      currentChapterIndex = index;
      const chapter = currentChapters[index];
      
      const readerContent = document.getElementById('readerContent');
      
      // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
      readerContent.style.opacity = '0.3';
      readerContent.style.transform = 'scale(0.98)';
      readerContent.style.transition = 'all 0.2s ease';
      
      setTimeout(() => {
        readerContent.innerHTML = `
          <h3 style="text-align: center; margin-bottom: 20px; font-size: 18px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px;">${chapter.title}</h3>
          <div style="text-align: center; font-size: 12px; color: var(--text-secondary); margin-bottom: 30px;">ç¬¬ ${index + 1} ç«  / å…± ${currentChapters.length} ç« </div>
          <p style="text-indent: 2em; line-height: 2;">${chapter.content.replace(/\n/g, '</p><p style="text-indent: 2em; line-height: 2;">')}</p>
        `;
        
        // æ·¡å…¥å’Œæ”¾å¤§åŠ¨ç”»
        readerContent.style.opacity = '1';
        readerContent.style.transform = 'scale(1)';
        readerContent.style.animation = 'slideInLeft 0.4s ease-out';
      }, 150);
      
      // æ›´æ–°ç›®å½•é«˜äº®
      document.querySelectorAll('.catalog-item').forEach((item, i) => {
        item.classList.remove('current');
        if (i === index) {
          item.classList.add('current');
          item.style.animation = 'pulse 0.5s ease-out';
          // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚
          setTimeout(() => {
            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 100);
        }
      });

      // ä¿å­˜é˜…è¯»è¿›åº¦
      saveReadingProgress();
      
      // æ˜¾ç¤ºè¿›åº¦æç¤º
      const progress = Math.round(((index + 1) / currentChapters.length) * 100);
      showToast(`ğŸ“– è¿›åº¦: ${progress}%`, 1500, 'info');
    }

    function prevChapter() { loadChapter(currentChapterIndex - 1); }
    function nextChapter() { loadChapter(currentChapterIndex + 1); }

    // ===================== ä¹¦æ¶åŠŸèƒ½ =====================
    function renderShelf() {
      const shelfList = document.getElementById('shelfList');
      if (shelfBooks.length === 0) {
        shelfList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px 0;">ğŸ“š æš‚æ— ä¹¦ç±ï¼Œå»æ·»åŠ å§</p>';
        return;
      }

      shelfList.innerHTML = '';
      
      // æŒ‰æœ€åé˜…è¯»æ—¶é—´æ’åº
      const sortedBooks = [...shelfBooks].sort((a, b) => {
        return (b.lastReadTime || 0) - (a.lastReadTime || 0);
      });

      sortedBooks.forEach((book, index) => {
        const item = document.createElement('div');
        item.className = 'book-item';
        item.style.animation = `slideUp 0.3s ease-out ${index * 50}ms both`;
        item.onclick = () => openBookFromShelf(book);
        
        // è®¡ç®—é˜…è¯»è¿›åº¦ç™¾åˆ†æ¯”
        const maxChapters = book.chapters?.length || 1;
        const progress = Math.round(((book.lastChapterIndex || 0) / maxChapters) * 100);
        
        item.innerHTML = `
          <div class="book-cover">
            <img src="${book.cover || 'https://via.placeholder.com/60x80?text=book'}" alt="${book.title}" loading="lazy">
            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(0,0,0,0.2);">
              <div style="height: 100%; width: ${progress}%; background: var(--primary); transition: width 0.3s ease;"></div>
            </div>
          </div>
          <div class="book-info" style="flex: 1;">
            <div class="book-title">${book.title}</div>
            <div class="book-author">ä½œè€…ï¼š${book.author}</div>
            <div class="book-progress">ç¬¬ ${book.lastChapterIndex || 0} ç«  Â· ${progress}%</div>
          </div>
        `;
        shelfList.appendChild(item);
      });
    }

    function addToShelf() {
      if (!currentBook) {
        showToast('âŒ å°šæœªæ‰“å¼€ä¹¦ç±', 1500, 'warning');
        return;
      }

      const existIndex = shelfBooks.findIndex(b => b.id === currentBook.id);
      
      const shelfBook = {
        ...currentBook,
        lastChapterIndex: currentChapterIndex,
        lastChapterTitle: currentChapters[currentChapterIndex]?.title,
        lastReadTime: Date.now()
      };

      if (existIndex > -1) {
        shelfBooks[existIndex] = shelfBook;
        showToast('âœ“ å·²æ›´æ–°ä¹¦æ¶è¿›åº¦', 1500, 'success');
      } else {
        shelfBooks.push(shelfBook);
        showToast('âœ“ å·²æ·»åŠ åˆ°ä¹¦æ¶', 1500, 'success');
      }

      localStorage.setItem('shelfBooks', JSON.stringify(shelfBooks));
      renderShelf();
    }

    function openBookFromShelf(book) {
      currentBook = book;
      currentChapters = book.chapters || genChapters(book.title);
      currentChapterIndex = book.lastChapterIndex || 0;
      
      renderCatalog();
      loadChapter(currentChapterIndex);
    }

    // ===================== è®¾ç½®åŠŸèƒ½ =====================
    function initSettings() {
      const settingsPanel = document.getElementById('pageMore');
      // åˆå§‹åŒ–è®¾ç½®é¡µé¢ä¸­çš„å…ƒç´ 
      const darkModeToggle = document.getElementById('darkModeToggle');
      if (darkModeToggle) {
        darkModeToggle.classList.toggle('active', isDarkMode);
      }
    }

    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      document.getElementById('darkModeToggle').classList.toggle('active', isDarkMode);
      localStorage.setItem('darkMode', isDarkMode);
      showToast(isDarkMode ? 'ğŸŒ™ å·²å¼€å¯å¤œé—´æ¨¡å¼' : 'â˜€ï¸ å·²å…³é—­å¤œé—´æ¨¡å¼', 1500, 'success');
      
      // æ·»åŠ è¿‡æ¸¡åŠ¨ç”»
      document.body.style.transition = 'background 0.3s ease, color 0.3s ease';
    }

    function clearCache() {
      if (confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä¹¦ç±ã€ä¹¦æºå’Œé˜…è¯»è¿›åº¦ï¼ç¡®å®šå—ï¼Ÿ')) {
        localStorage.removeItem('sources');
        localStorage.removeItem('shelfBooks');
        localStorage.removeItem('readingProgress');
        localStorage.removeItem('darkMode');
        sources = [];
        shelfBooks = [];
        booksCache = {};
        window.readingProgress = {};
        isDarkMode = false;
        
        renderSources();
        renderShelf();
        initDarkMode();
        
        showToast('âœ“ ç¼“å­˜å·²æ¸…é™¤ï¼Œåº”ç”¨å°†åˆ·æ–°', 1500, 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      }
    }

    function showToast(msg, duration = 2500, type = 'info') {
      const toast = document.getElementById('toast');
      
      // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
      if (toast.timeoutId) {
        clearTimeout(toast.timeoutId);
      }
      if (toast.hideTimeoutId) {
        clearTimeout(toast.hideTimeoutId);
      }
      
      // è®¾ç½®æ ·å¼æ ¹æ®ç±»å‹
      toast.style.background = {
        'success': '#27ae60',
        'error': '#dc3545',
        'warning': '#f39c12',
        'info': 'rgba(0,0,0,0.7)'
      }[type] || 'rgba(0,0,0,0.7)';
      
      toast.innerText = msg;
      toast.classList.add('show');
      toast.style.animation = 'slideUp 0.3s ease-out';
      
      toast.timeoutId = setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease-out forwards';
        toast.hideTimeoutId = setTimeout(() => {
          toast.classList.remove('show');
        }, 300);
      }, duration);
    }
  </script>
</body>
</html>
